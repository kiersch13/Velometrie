<!-- Loading -->
<div *ngIf="loading" class="flex flex-col items-center justify-center mt-20 text-gray-400 gap-3">
  <lucide-icon name="loader-2" [size]="36" class="animate-spin" aria-hidden="true"></lucide-icon>
  <span class="text-sm">Lädt...</span>
</div>

<!-- Error -->
<div *ngIf="error" class="flex items-center gap-2 mt-6 p-4 bg-error/10 border border-error/20 rounded-xl text-error text-sm">
  <lucide-icon name="alert-circle" [size]="16" aria-hidden="true"></lucide-icon>
  {{ error }}
</div>

<ng-container *ngIf="bike">
  <!-- Back link -->
  <button class="btn-secondary text-xs mb-6 border-0 px-0 hover:border-0" (click)="goBack()">
    <lucide-icon name="arrow-left" [size]="14" aria-hidden="true"></lucide-icon>
    Zurück zur Übersicht
  </button>

  <!-- Bike header -->
  <div class="card p-6 mb-8">
    <div class="flex justify-between items-start flex-wrap gap-4">
      <div>
        <span class="badge mb-2">{{ bike.kategorie }}</span>
        <h2 class="mt-1 text-3xl font-bold text-primary dark:text-text-dark">{{ bike.name }}</h2>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <ng-container *ngIf="!editingKm">
          <div class="text-right">
            <p class="text-xs text-gray-400 mb-0.5">Kilometerstand</p>
            <span class="text-2xl font-bold text-primary dark:text-text-dark">{{ bike.kilometerstand | number:'1.0-0' }} km</span>
          </div>
          <button class="btn-secondary" aria-label="Kilometerstand bearbeiten" (click)="editingKm = true">
            <lucide-icon name="pencil" [size]="14" aria-hidden="true"></lucide-icon>
            Bearbeiten
          </button>
        </ng-container>
        <ng-container *ngIf="editingKm">
          <input type="number" [(ngModel)]="newKilometerstand"
                 class="form-input w-36" aria-label="Neuer Kilometerstand" />
          <button class="btn-primary" (click)="saveKilometerstand()">
            <lucide-icon name="check" [size]="14" aria-hidden="true"></lucide-icon>
            Speichern
          </button>
          <button class="btn-secondary" (click)="editingKm = false">Abbrechen</button>
        </ng-container>
        <button class="btn-danger" (click)="deleteBike()">
          <lucide-icon name="trash-2" [size]="14" aria-hidden="true"></lucide-icon>
          Rad löschen
        </button>
      </div>
    </div>
  </div>

  <!-- Wear parts header -->
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold text-primary dark:text-text-dark">Verschleißteile</h3>
    <button class="btn-primary" (click)="showWearPartForm = !showWearPartForm">
      <lucide-icon name="plus" [size]="14" aria-hidden="true"></lucide-icon>
      {{ showWearPartForm ? 'Abbrechen' : 'Verschleißteil hinzufügen' }}
    </button>
  </div>

  <app-wear-part-form
    *ngIf="showWearPartForm && bike"
    [radId]="bike.id"
    [currentKilometerstand]="bike.kilometerstand"
    (saved)="onWearPartAdded()">
  </app-wear-part-form>

  <!-- Empty wear parts -->
  <div *ngIf="wearParts.length === 0 && !showWearPartForm"
       class="flex flex-col items-center justify-center py-16 text-gray-400 gap-3">
    <lucide-icon name="inbox" [size]="40" class="text-gray-300" aria-hidden="true"></lucide-icon>
    <div class="text-center">
      <p class="font-semibold text-gray-500 text-sm">Noch keine Verschleißteile</p>
      <p class="text-xs mt-1">Füge das erste Verschleißteil hinzu.</p>
    </div>
  </div>

  <!-- Wear parts table -->
  <div *ngIf="wearParts.length > 0" class="card overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-100 dark:border-gray-700">
            <th class="bg-gray-50 dark:bg-gray-800/60 w-1 p-0"></th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Kategorie</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Einbau</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Gefahren</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Erw. Ersatz</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-20">Aktionen</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
          <tr *ngFor="let part of sortedWearParts"
              class="hover:bg-gray-50/60 dark:hover:bg-gray-800/30 transition-colors duration-100"
              [ngClass]="{'opacity-50': !isInstalled(part)}">
            <!-- Status bar -->
            <td class="w-1 p-0">
              <div class="w-1 min-h-[2.75rem] rounded-sm" [ngClass]="getStatusBarClass(part)"></div>
            </td>
            <td class="px-4 py-3 font-medium text-gray-800 dark:text-text-dark">{{ part.name }}</td>
            <td class="px-4 py-3"><span class="badge">{{ part.kategorie }}</span></td>
            <td class="px-4 py-3 text-gray-600 dark:text-text-dark">{{ part.einbauDatum | date:'dd.MM.yyyy' }}</td>
            <!-- Gefahrene km -->
            <td class="px-4 py-3 tabular-nums">
              <span class="text-gray-800 dark:text-text-dark font-medium">{{ getGefahreneKm(part) | number:'1.0-0' }} km</span>
              <!-- Progress bar -->
              <div class="w-20 h-1 bg-gray-100 dark:bg-gray-700 rounded-full mt-1 overflow-hidden">
                <div class="h-full rounded-full transition-all duration-300"
                     [ngClass]="{
                       'bg-success/70': getLifetimePercent(part) < 0.8 && isInstalled(part),
                       'bg-warning/80': getLifetimePercent(part) >= 0.8 && getLifetimePercent(part) < 1.0 && isInstalled(part),
                       'bg-error/80': getLifetimePercent(part) >= 1.0 && isInstalled(part),
                       'bg-gray-300 dark:bg-gray-500': !isInstalled(part)
                     }"
                     [style.width.%]="(getLifetimePercent(part) * 100) | number:'1.0-0'">
                </div>
              </div>
            </td>
            <!-- Expected replacement km -->
            <td class="px-4 py-3 text-gray-600 dark:text-text-dark tabular-nums">
              <span [ngClass]="{
                'text-warning font-medium': isInstalled(part) && getLifetimePercent(part) >= 0.8 && getLifetimePercent(part) < 1.0,
                'text-error font-semibold': isInstalled(part) && getLifetimePercent(part) >= 1.0
              }">
                {{ getExpectedReplacementKm(part) | number:'1.0-0' }} km
              </span>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-1">
                <button class="btn-secondary !p-1.5" aria-label="Bearbeiten" (click)="startEditWearPart(part)">
                  <lucide-icon name="pencil" [size]="13" aria-hidden="true"></lucide-icon>
                </button>
                <button class="btn-danger !p-1.5" aria-label="Löschen" (click)="deleteWearPart(part.id)">
                  <lucide-icon name="trash-2" [size]="13" aria-hidden="true"></lucide-icon>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Inline wear part edit form -->
  <div *ngIf="editingWearPart" class="card p-6 mt-4">
    <h4 class="text-sm font-semibold text-primary dark:text-text-dark mb-4 flex items-center gap-2">
      <lucide-icon name="pencil" [size]="14" class="text-accent" aria-hidden="true"></lucide-icon>
      Verschleißteil bearbeiten
    </h4>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-500 dark:text-text-dark">Name</label>
        <input type="text" [(ngModel)]="editingWearPart.name" class="form-input" />
      </div>
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-500 dark:text-text-dark">Kategorie</label>
        <select [(ngModel)]="editingWearPart.kategorie" class="form-input">
          <option value="Reifen">Reifen</option>
          <option value="Kassette">Kassette</option>
          <option value="Kettenblatt">Kettenblatt</option>
          <option value="Kette">Kette</option>
          <option value="Sonstiges">Sonstiges</option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-500 dark:text-text-dark">Einbau Kilometerstand</label>
        <input type="number" [(ngModel)]="editingWearPart.einbauKilometerstand" min="0" class="form-input" />
      </div>
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-500 dark:text-text-dark">Einbau Datum</label>
        <input type="date" [(ngModel)]="editEinbauDatumStr" class="form-input" />
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-500 dark:text-text-dark">
          Ausbau Kilometerstand
          <span class="font-normal text-gray-400 ml-1">(optional)</span>
        </label>
        <input type="number" [(ngModel)]="editingWearPart.ausbauKilometerstand" min="0" class="form-input" />
      </div>
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-500 dark:text-text-dark">
          Ausbau Datum
          <span class="font-normal text-gray-400 ml-1">(optional)</span>
        </label>
        <input type="date" [(ngModel)]="editAusbauDatumStr" class="form-input" />
      </div>
    </div>

    <div class="flex items-center gap-2 pt-4 border-t border-gray-100 dark:border-gray-700">
      <button class="btn-primary" (click)="saveWearPart()">
        <lucide-icon name="check" [size]="14" aria-hidden="true"></lucide-icon>
        Speichern
      </button>
      <button class="btn-secondary" (click)="editingWearPart = null">Abbrechen</button>
    </div>
  </div>
</ng-container>
