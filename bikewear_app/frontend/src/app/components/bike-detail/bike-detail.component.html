<!-- Loading -->
<div *ngIf="loading" class="flex flex-col items-center justify-center mt-20 text-gray-400 gap-3">
  <lucide-icon name="loader-2" [size]="36" class="animate-spin" aria-hidden="true"></lucide-icon>
  <span class="text-sm">Lädt...</span>
</div>

<!-- Error -->
<div *ngIf="error" class="flex items-center gap-2 mt-6 p-4 bg-error/10 border border-error/20 rounded-xl text-error text-sm">
  <lucide-icon name="alert-circle" [size]="16" aria-hidden="true"></lucide-icon>
  {{ error }}
</div>

<ng-container *ngIf="bike">
  <!-- Back link -->
  <button class="btn-secondary text-xs mb-6 border-0 px-0 hover:border-0" (click)="goBack()">
    <lucide-icon name="arrow-left" [size]="14" aria-hidden="true"></lucide-icon>
    Zurück zur Übersicht
  </button>

  <!-- Bike header -->
  <div class="card p-6 mb-8">
    <div class="flex justify-between items-start flex-wrap gap-4">
      <div>
        <span class="badge mb-2">{{ bike.kategorie }}</span>
        <h2 class="mt-1 text-3xl font-bold text-primary dark:text-text-dark">{{ bike.name }}</h2>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <ng-container *ngIf="!editingKm">
          <div class="text-right">
            <p class="text-xs text-gray-400 mb-0.5">Kilometerstand</p>
            <span class="text-2xl font-bold text-primary dark:text-text-dark">{{ bike.kilometerstand | number:'1.0-0' }} km</span>
          </div>
          <button class="btn-secondary" aria-label="Kilometerstand bearbeiten" (click)="editingKm = true">
            <lucide-icon name="pencil" [size]="14" aria-hidden="true"></lucide-icon>
            Bearbeiten
          </button>
        </ng-container>
        <ng-container *ngIf="editingKm">
          <input type="number" [(ngModel)]="newKilometerstand"
                 class="form-input w-36" aria-label="Neuer Kilometerstand" />
          <button class="btn-primary" (click)="saveKilometerstand()">
            <lucide-icon name="check" [size]="14" aria-hidden="true"></lucide-icon>
            Speichern
          </button>
          <button class="btn-secondary" (click)="editingKm = false">Abbrechen</button>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Wear parts header -->
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold text-primary dark:text-text-dark">Verschleißteile</h3>
    <button class="btn-primary" (click)="showWearPartForm = !showWearPartForm">
      <lucide-icon name="plus" [size]="14" aria-hidden="true"></lucide-icon>
      {{ showWearPartForm ? 'Abbrechen' : 'Verschleißteil hinzufügen' }}
    </button>
  </div>

  <app-wear-part-form
    *ngIf="showWearPartForm && bike"
    [radId]="bike.id"
    [currentKilometerstand]="bike.kilometerstand"
    (saved)="onWearPartAdded()">
  </app-wear-part-form>

  <!-- Empty wear parts -->
  <div *ngIf="wearParts.length === 0 && !showWearPartForm"
       class="flex flex-col items-center justify-center py-16 text-gray-400 gap-3">
    <lucide-icon name="inbox" [size]="40" class="text-gray-300" aria-hidden="true"></lucide-icon>
    <div class="text-center">
      <p class="font-semibold text-gray-500 text-sm">Noch keine Verschleißteile</p>
      <p class="text-xs mt-1">Füge das erste Verschleißteil hinzu.</p>
    </div>
  </div>

  <!-- Wear parts table -->
  <div *ngIf="wearParts.length > 0" class="card overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-100 dark:border-gray-700">
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Kategorie</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Einbau km</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Einbau</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Ausbau km</th>
            <th class="bg-gray-50 dark:bg-gray-800/60 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Ausbau</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
          <tr *ngFor="let part of wearParts" class="hover:bg-gray-50/60 dark:hover:bg-gray-800/30 transition-colors duration-100">
            <td class="px-4 py-3 font-medium text-gray-800 dark:text-text-dark">{{ part.name }}</td>
            <td class="px-4 py-3"><span class="badge">{{ part.kategorie }}</span></td>
            <td class="px-4 py-3 text-gray-600 dark:text-text-dark tabular-nums">{{ part.einbauKilometerstand | number:'1.0-0' }} km</td>
            <td class="px-4 py-3 text-gray-600 dark:text-text-dark">{{ part.einbauDatum | date:'dd.MM.yyyy' }}</td>
            <td class="px-4 py-3 text-gray-600 dark:text-text-dark tabular-nums">{{ part.ausbauKilometerstand ? (part.ausbauKilometerstand | number:'1.0-0') + ' km' : '—' }}</td>
            <td class="px-4 py-3 text-gray-600 dark:text-text-dark">{{ part.ausbauDatum ? (part.ausbauDatum | date:'dd.MM.yyyy') : '—' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</ng-container>
